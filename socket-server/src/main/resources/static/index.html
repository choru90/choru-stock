<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Live Stock Ticks</title>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f5f5f5; margin:0; }
        h1 { background-color: #003366; color:#fff; padding: 10px 20px; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { padding: 8px 12px; border-bottom: 1px solid #ddd; }
        th { background-color: #e0e0e0; text-align: left; }
        tr:nth-child(even) { background-color: #fafafa; }
    </style>
    <!-- STOMP 클라이언트와 SockJS 로더 -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="stomp.min.js"></script>
</head>
<body>
<h1>Live Stock Ticks</h1>
<div style="padding:0 20px;">
    <label for="symbolSelect">Symbol:</label>
    <select id="symbolSelect"></select>
</div>
<table id="tick-table">
    <thead>
    <tr>
        <th>Symbol</th>
        <th>Price</th>
        <th>Timestamp</th>
        <th>Volume</th>
    </tr>
    </thead>
    <tbody></tbody>
</table>

<script>
    const tbody = document.querySelector('#tick-table tbody');
    const symbolSelect = document.getElementById('symbolSelect');
    const availableSymbols = ['AAPL', 'GOOG', 'TSLA', 'AMZN'];

    // 드롭다운에 종목 옵션 추가
    availableSymbols.forEach(symbol => {
        const option = document.createElement('option');
        option.value = symbol;
        option.textContent = symbol;
        symbolSelect.appendChild(option);
    });

    // STOMP 클라이언트 초기화
    const socket = new SockJS('/ws');
    const stompClient = Stomp.over(socket);
    let currentSubscription = null;

    function subscribeTo(symbol) {
        if (currentSubscription) {
            currentSubscription.unsubscribe();
        }
        tbody.innerHTML = '';
        currentSubscription = stompClient.subscribe(`/topic/ticks/${symbol}`, message => {
            const tick = JSON.parse(message.body);
            addRow(tick);
        });
    }

    // 서버에 연결된 후 선택된 종목을 구독한다
    stompClient.connect({}, () => {
        subscribeTo(symbolSelect.value);
    });

    // 선택 변경 시 새 종목을 구독한다
    symbolSelect.addEventListener('change', () => {
        if (stompClient.connected) {
            subscribeTo(symbolSelect.value);
        }
    });

    // 수신한 tick 을 화면에 추가
    function addRow(tick) {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${tick.symbol}</td>
            <td>${tick.price}</td>
            <td>${new Date(tick.timestamp).toLocaleString()}</td>
            <td>${tick.volume}</td>`;
        tbody.prepend(row);
        // 50개 이상이면 오래된 데이터 삭제
        if (tbody.rows.length > 50) {
            tbody.removeChild(tbody.lastChild);
        }
    }
</script>
</body>
</html>
